<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 400px }
    </style>
    <title>Document</title>
</head>
<body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js">
    </script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css">
    <h1> Django Home </h1> 
<div id="map"></div>
<div>
    {% if user.is_authenticated %}
    <h2> Rent! </h2>
    <!-- code for authenticated user -->
    {% else %}
        <h2> Register here! </h2>
        <!-- code for unauthenticated user -->
    {% endif %}
 </div>
<script>
    mapboxgl.accessToken = '{{ mapbox_access_token }}';
    const map = new mapboxgl.Map({
    container: 'map', // container ID
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
    //style: 'mapbox://styles/mapbox/streets-v12', // style URL
    //style: 'mapbox://styles/mapbox/navigation-night-v1',
    style: 'mapbox://styles/mapbox/streets-v12',

    //style: 'mapbox://styles/mapbox/dark-v11',
    center: [-4.25, 55.865], // starting position [lng, lat]
    zoom: 14 // starting zoom
});

my_marker = null;


geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    // localGeocoder: coordinatesGeocoder,
    zoom: 15,
    placeholder: 'Your current address',
    mapboxgl: mapboxgl,
    reverseGeocode: true,
    minLength: 3,
    marker: false,
    proximity: { // Glasgow University Address
        longitude: -4.24,
        latitude: 55.86
    }
})

{% comment %} geocoder.on('result', e => {
    const marker = new mapboxgl.Marker({
      draggable: true,
      color: 'red'
    })
    .setLngLat(e.result.center)
    .addTo(map)
    marker.on('dragend',function(e){
      var lngLat = e.target.getLngLat();
      console.log(lngLat['lat'])
      console.log(lngLat['lng'])
    })
  }) {% endcomment %}

  geocoder.on('result', e => {
    // Remove previous marker if it exists
    if (my_marker) {
        my_marker.remove();
    }
    console.log("Here")
    console.log( e.result)
    // Create new marker
    my_marker = new mapboxgl.Marker({
      draggable: true,
      color: 'red'
    })
    .setLngLat(e.result.center)
    .addTo(map);
    
    marker.on('dragend', function(e) {
        var lngLat = e.target.getLngLat();
        console.log(lngLat['lat'])
        console.log(lngLat['lng'])
    });
});

map.addControl(geocoder)
        map.on('load', function () {
            // Get the geocoder instance
            const geocoder = document.querySelector('.mapboxgl-ctrl-geocoder input');

            // Add a listener for when a place is selected
            geocoder.addEventListener('change', function () {
                // Get the selected place
                const place = document.querySelector('.mapboxgl-ctrl-geocoder--suggestion-title')
                    .textContent;

                // Get the coordinates of the selected place
                const coordinates = map.getCenter();

                // Log the place and coordinates
                console.log(place, coordinates);
            });
        });

{% for loc in locations %}
    var marker = new mapboxgl.Marker()
        .setLngLat([{{ loc.longitude }}, {{ loc.latitude }}])
        .setPopup(new mapboxgl.Popup().setHTML("<h2> {{ loc.address}} </h2>"))
        .addTo(map)
{% endfor %} 

</script>
</body>
</html> 